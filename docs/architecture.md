# Browser Toolkit ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Browser Toolkitã®è¨­è¨ˆåŸå‰‡ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ãŠã‚ˆã³ä¸»è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

- [å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
- [ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å¢ƒç•Œ](#ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å¢ƒç•Œ)
- [IDç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ](#idç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ )
- [AIçµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹](#aiçµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹)
- [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
- [è¨­è¨ˆåŸå‰‡](#è¨­è¨ˆåŸå‰‡)

---

## å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

Browser Toolkitã¯ã€Chrome Extensionï¼ˆManifest V3ï¼‰ã¨ã—ã¦æ§‹ç¯‰ã•ã‚ŒãŸã€å€‹äººç”¨ã®ç”Ÿç”£æ€§å‘ä¸Šãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Chrome Extension                         â”‚
â”‚                    (Manifest V3)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Background  â”‚  â”‚   Content    â”‚  â”‚    Popup     â”‚     â”‚
â”‚  â”‚    Worker    â”‚  â”‚    Script    â”‚  â”‚      UI      â”‚     â”‚
â”‚  â”‚ (Service     â”‚  â”‚  (Page DOM)  â”‚  â”‚   (React)    â”‚     â”‚
â”‚  â”‚  Worker)     â”‚  â”‚              â”‚  â”‚              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚        â”‚                  â”‚                  â”‚              â”‚
â”‚        â”‚    chrome.       â”‚    chrome.       â”‚              â”‚
â”‚        â”‚   runtime.       â”‚   runtime.       â”‚              â”‚
â”‚        â”‚  sendMessage     â”‚  sendMessage     â”‚              â”‚
â”‚        â”‚                  â”‚                  â”‚              â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â”‚                                 â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                 â”‚  Message Passing   â”‚                      â”‚
â”‚                 â”‚   (Type-safe)      â”‚                      â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å¢ƒç•Œ

Browser Toolkitã¯3ã¤ã®ç‹¬ç«‹ã—ãŸå®Ÿè¡Œç’°å¢ƒï¼ˆãƒ©ãƒ³ã‚¿ã‚¤ãƒ å¢ƒç•Œï¼‰ã‚’æŒã¡ã€ãã‚Œãã‚ŒãŒç•°ãªã‚‹è²¬å‹™ã‚’æ‹…ã„ã¾ã™ã€‚

### 1. Background Worker (`src/background.ts`)

**å½¹å‰²**: ç‰¹æ¨©APIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¨ã€ãƒšãƒ¼ã‚¸é–“ã§å…±æœ‰ã•ã‚Œã‚‹çŠ¶æ…‹ç®¡ç†

**ä¸»ãªæ©Ÿèƒ½**:

- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ç®¡ç†ï¼ˆ`chrome.contextMenus`ï¼‰
- OpenAI/Anthropic/z.ai APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆfetchï¼‰
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†ï¼ˆ`chrome.storage.sync`, `chrome.storage.local`ï¼‰
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆ`chrome.runtime.onMessage`ï¼‰

**ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªAPI**:

- âœ… `chrome.contextMenus`
- âœ… `chrome.storage`
- âœ… `chrome.tabs`
- âœ… `fetch` (CORSåˆ¶é™ãªã—)
- âŒ ãƒšãƒ¼ã‚¸DOMï¼ˆã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰

### 2. Content Script (`src/content.ts`)

**å½¹å‰²**: ãƒšãƒ¼ã‚¸ã®DOMæ“ä½œã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®æ¤œå‡º

**ä¸»ãªæ©Ÿèƒ½**:

- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã®æ³¨å…¥
- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤UIï¼ˆContext Actionsçµæœè¡¨ç¤ºï¼‰
- é¸æŠãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—ã¨é€ä¿¡
- MutationObserverã«ã‚ˆã‚‹å‹•çš„ãƒ†ãƒ¼ãƒ–ãƒ«æ¤œå‡º

**ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªAPI**:

- âœ… ãƒšãƒ¼ã‚¸DOMï¼ˆèª­ã¿å–ã‚Š/æ›¸ãè¾¼ã¿ï¼‰
- âœ… Shadow DOMï¼ˆã‚¹ã‚¿ã‚¤ãƒ«éš”é›¢ï¼‰
- âœ… `chrome.runtime.sendMessage`
- âŒ `chrome.contextMenus`ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰
- âŒ CORSåˆ¶é™ãªã—ã®fetchï¼ˆã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰

### 3. Popup UI (`src/popup.ts`)

**å½¹å‰²**: è¨­å®šç”»é¢ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

**ä¸»ãªæ©Ÿèƒ½**:

- è¨­å®šç®¡ç†ï¼ˆAPIãƒˆãƒ¼ã‚¯ãƒ³ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é¸æŠã€ãƒ¢ãƒ‡ãƒ«é¸æŠï¼‰
- ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ä½œæˆ/ç·¨é›†
- ãƒ†ã‚­ã‚¹ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
- æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†

**ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªAPI**:

- âœ… `chrome.runtime.sendMessage`
- âœ… `chrome.storage`
- âœ… `chrome.tabs`ï¼ˆé™å®šçš„ï¼‰
- âŒ ãƒšãƒ¼ã‚¸DOMï¼ˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒƒã‚·ãƒ³ã‚°

ãƒ©ãƒ³ã‚¿ã‚¤ãƒ é–“ã®é€šä¿¡ã¯ã€å‹å®‰å…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒƒã‚·ãƒ³ã‚°ã§è¡Œã„ã¾ã™ã€‚

```typescript
// src/background/runtime_types.ts
type RuntimeRequest =
  | { action: "summarizeText"; target: SummaryTarget }
  | { action: "testAiToken"; token?: string }
  | { action: "summarizeEvent"; target: SummaryTarget }
  | { action: "openPopupSettings" };
// ...

// é€ä¿¡å´ï¼ˆContent Scriptï¼‰
chrome.runtime.sendMessage(
  { action: "summarizeText", target: { text, source, title, url } },
  (response) => {
    /* çµæœå‡¦ç† */
  },
);

// å—ä¿¡å´ï¼ˆBackground Workerï¼‰
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === "summarizeText") {
    handleSummarizeTextRequest(request, sendResponse);
    return true; // éåŒæœŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
  }
});
```

**è¨­è¨ˆåŸå‰‡**:

- **å‹å®‰å…¨æ€§**: unionå‹ã§å…¨ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã‚’å®šç¾©
- **å°ã•ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: è­˜åˆ¥å¯èƒ½ã§ã€ãƒ†ã‚¹ãƒˆå¯èƒ½ãªç²’åº¦
- **éåŒæœŸå¯¾å¿œ**: `return true` ã§éåŒæœŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä¿è¨¼

---

## IDç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 

Browser Toolkitã§ã¯ã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã‚„ãƒ†ã‚­ã‚¹ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã©ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã™ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ä¸€æ„ãªIDã‚’ä»˜ä¸ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### è¨­è¨ˆç›®æ¨™

1. **è¡çªå›é¿**: åŒã˜åå‰ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã‚‚ç•°ãªã‚‹IDã‚’ç”Ÿæˆ
2. **å¯èª­æ€§**: ãƒ‡ãƒãƒƒã‚°æ™‚ã«IDã‹ã‚‰å…ƒã®åå‰ã‚’æ¨æ¸¬å¯èƒ½
3. **ä¸€è²«æ€§**: åŒã˜åå‰ã«å¯¾ã—ã¦å¸¸ã«åŒã˜IDã‚’ç”Ÿæˆï¼ˆã¹ãç­‰æ€§ï¼‰

### å®Ÿè£…

`src/utils/id_generator.ts` ã«çµ±ä¸€ã•ã‚ŒãŸIDç”Ÿæˆé–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

```typescript
/**
 * ä¸€æ„ãªIDã‚’ç”Ÿæˆ
 * @param name åå‰ï¼ˆæ—¥æœ¬èªã‚„ã‚¹ãƒšãƒ¼ã‚¹ã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰
 * @param prefix IDã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆä¾‹: "group", "template"ï¼‰
 * @returns "{prefix}:{slug}-{hash}" å½¢å¼ã®ID
 */
export function generateId(name: string, prefix: string): string {
  const slug = name
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-|-$/g, "");

  const hash = simpleHash(name).substring(0, 8);

  if (slug.length === 0) {
    return `${prefix}:${hash}`;
  }

  return `${prefix}:${slug}-${hash}`;
}
```

### ä½¿ç”¨ä¾‹

```typescript
// æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
generateId("ãŠè²·ã„ç‰©", "group");
// â†’ "group:e8c8a7d5" (éASCIIæ–‡å­—ã®ã¿ â†’ ãƒãƒƒã‚·ãƒ¥ã®ã¿)

generateId("Shopping", "group");
// â†’ "group:shopping-a1b2c3d4" (slug + hash)

// ãƒ†ã‚­ã‚¹ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
generateId("LGTM", "template");
// â†’ "template:lgtm-0023a134"
```

### ãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

```typescript
function simpleHash(str: string): string {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = (hash << 5) - hash + char;
    hash &= hash; // 32bitæ•´æ•°ã«å¤‰æ›
  }
  return Math.abs(hash).toString(16).padStart(8, "0");
}
```

**ç‰¹å¾´**:

- é«˜é€Ÿï¼ˆO(n)ã€nã¯æ–‡å­—åˆ—é•·ï¼‰
- è¡çªç‡ä½ã„ï¼ˆ32bitãƒãƒƒã‚·ãƒ¥ï¼‰
- éASCIIæ–‡å­—å¯¾å¿œï¼ˆUTF-16 codePointã‚’ä½¿ç”¨ï¼‰

### ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®çµŒç·¯

**Before** (similarity-tsåˆ†æ: 80%é‡è¤‡):

- `src/search_engine_groups.ts` ã« `simpleHash` + `generateGroupId`
- `src/text_templates.ts` ã« `simpleHash` + `generateTemplateId`
- åˆè¨ˆ80è¡Œã®é‡è¤‡ã‚³ãƒ¼ãƒ‰

**After**:

- `src/utils/id_generator.ts` ã«çµ±ä¸€
- å„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `generateId(name, prefix)` ã‚’å‘¼ã³å‡ºã™ã ã‘
- 51è¡Œã«å‰Šæ¸›ï¼ˆ-36%ï¼‰

---

## AIçµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

Browser Toolkitã¯ã€è¤‡æ•°ã®AIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆOpenAIã€Anthropicã€z.aiï¼‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Unified AI Interface                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         prepareAiInput()                       â”‚    â”‚
â”‚  â”‚  - ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰                     â”‚    â”‚
â”‚  â”‚  - å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—                         â”‚    â”‚
â”‚  â”‚  - ãƒ¡ã‚¿æƒ…å ±ã‚’æ§‹ç¯‰                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                       â”‚                                 â”‚
â”‚                       â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         requestAiText()                        â”‚    â”‚
â”‚  â”‚  - ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’å–å¾—                 â”‚    â”‚
â”‚  â”‚  - APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡                          â”‚    â”‚
â”‚  â”‚  - çµæœã‚’è¿”ã™                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                       â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚         â–¼             â–¼             â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ OpenAI   â”‚ â”‚ Anthropicâ”‚ â”‚  z.ai    â”‚              â”‚
â”‚  â”‚ Adapter  â”‚ â”‚ Adapter  â”‚ â”‚ Adapter  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‹å®šç¾©

```typescript
// src/background/openai_common.ts
export type PreparedAiInput = {
  settings: AiSettings; // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã€ãƒ¢ãƒ‡ãƒ«ã€ãƒˆãƒ¼ã‚¯ãƒ³ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
  clippedText: string; // 20,000æ–‡å­—ã«åˆ¶é™ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ
  meta: string; // ã‚¿ã‚¤ãƒˆãƒ«ã€URLæƒ…å ±
};

// src/ai/settings.ts
export type AiSettings = {
  provider: AiProvider; // "openai" | "anthropic" | "zai"
  model: string; // ãƒ¢ãƒ‡ãƒ«ID
  token: string; // APIãƒˆãƒ¼ã‚¯ãƒ³
  customPrompt?: string; // ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
};
```

### ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼

```typescript
// src/ai/get-adapter.ts
export function getAdapter(provider: AiProvider): AiAdapter {
  switch (provider) {
    case "openai":
      return openAiAdapter;
    case "anthropic":
      return anthropicAdapter;
    case "zai":
      return zaiAdapter;
  }
}

// å„ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¯å…±é€šã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…
export type AiAdapter = {
  buildUrl: () => string;
  buildHeaders: (token: string) => Record<string, string>;
  parseResponse: (data: unknown) => string | null;
};
```

### ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®çµŒç·¯

**Before** (similarity-tsåˆ†æ: 83ã€œ90%é‡è¤‡):

- OpenAIå°‚ç”¨é–¢æ•°: `prepareOpenAiInput`, `_requestOpenAiText`, `testOpenAiToken`
- OpenAIå°‚ç”¨å‹: `PreparedOpenAiInput`, `OpenAiTextRequest`
- ãƒãƒ«ãƒãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é–¢æ•°ã¨ä¸¦å­˜ï¼ˆéæ¸¡æœŸï¼‰

**After**:

- AIçµ±ä¸€é–¢æ•°: `prepareAiInput`, `requestAiText`, `testAiToken`
- AIçµ±ä¸€å‹: `PreparedAiInput`, `AiTextRequest`
- ãƒ¬ã‚¬ã‚·ãƒ¼é–¢æ•°ã‚’å®Œå…¨å‰Šé™¤ï¼ˆ-137è¡Œï¼‰

### åˆ©ç‚¹

1. **ä¿å®ˆæ€§**: ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¿½åŠ æ™‚ã€ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ã ã‘
2. **ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§**: å…±é€šã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ãƒ¢ãƒƒã‚¯ãŒä½œã‚Šã‚„ã™ã„
3. **å‹å®‰å…¨æ€§**: ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å›ºæœ‰ã®ãƒã‚°ã‚’é˜²ã

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

Browser Toolkitã¯ã€`@praha/byethrow` ã® `Result` å‹ã‚’ä½¿ç”¨ã—ãŸçµ±ä¸€çš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

### Resultå‹ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
import { Result } from "@praha/byethrow";

// æˆåŠŸ
Result.succeed(value); // Result<T, never>

// å¤±æ•—
Result.fail(error); // Result<never, E>

// å‹ã‚¬ãƒ¼ãƒ‰
if (Result.isFailure(result)) {
  console.error(result.error);
  return;
}

// æˆåŠŸæ™‚ã®å€¤ã‚’ä½¿ç”¨
const value = result.value;
```

### è¨­è¨ˆãƒ«ãƒ¼ãƒ«

**å†…éƒ¨é–¢æ•°**: å¸¸ã« `Result` å‹ã‚’è¿”ã™

```typescript
// src/background/openai_common.ts
export async function prepareAiInput(params: {
  target: SummaryTarget;
  missingTextMessage: string;
  includeMissingMeta?: boolean;
}): Promise<Result.Result<PreparedAiInput, string>> {
  const settingsResult = loadAiSettings(storage);
  if (Result.isFailure(settingsResult)) {
    return Result.fail(settingsResult.error); // ã‚¨ãƒ©ãƒ¼ä¼æ’­
  }

  const clippedText = clipInputText(params.target.text);
  if (!clippedText) {
    return Result.fail(params.missingTextMessage);
  }

  return Result.succeed({ settings, clippedText, meta });
}
```

**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¢ƒç•Œ**: `{ ok: true/false }` ã«å¤‰æ›

```typescript
// src/background/runtime_handlers.ts
function handleTestAiTokenRequest(
  request: { action: "testAiToken"; token?: string },
  sendResponse: RuntimeSendResponse,
): boolean {
  (async () => {
    const result = await testAiToken(request.token);

    // Result â†’ { ok: true/false } ã«å¤‰æ›
    if (Result.isFailure(result)) {
      sendResponse(Result.fail(result.error));
      return;
    }
    sendResponse(Result.succeed({}));
  })();
  return true;
}
```

### åˆ©ç‚¹

1. **å‹å®‰å…¨**: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã‚’æ˜ç¤ºçš„ã«æ‰±ã†
2. **ã‚¨ãƒ©ãƒ¼ä¼æ’­**: `if (Result.isFailure)` ã§ç°¡æ½”ã«ä¼æ’­
3. **ä¸€è²«æ€§**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§çµ±ä¸€ã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³

---

## è¨­è¨ˆåŸå‰‡

### 1. å‹å®‰å…¨æ€§å„ªå…ˆ

- **strict modeæœ‰åŠ¹**: `tsconfig.json` ã§ `"strict": true`
- **anyå‹ç¦æ­¢**: å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚„anyå‹ã®ä½¿ç”¨ã‚’é¿ã‘ã‚‹
- **å…¥åŠ›æ¤œè¨¼**: `Valibot` ã§ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼

### 2. ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼è¨­è¨ˆ

- **å°ã•ãªè²¬å‹™**: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å˜ä¸€è²¬ä»»åŸå‰‡ã«å¾“ã†
- **è–„ã„å…±æœ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: å¤§ããªå…±æœ‰ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’é¿ã‘ã‚‹
- **ç‹¬ç«‹æ€§**: ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å¢ƒç•Œã‚’å°Šé‡ã—ã€ä¾å­˜ã‚’æœ€å°åŒ–

### 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- **XSSå¯¾ç­–å¿…é ˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ DOM ã«æŒ¿å…¥ã™ã‚‹å‰ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
- **innerHTMLç¦æ­¢**: `textContent` ã¾ãŸã¯ `createElement` ã‚’ä½¿ç”¨
- **å…¥åŠ›æ¤œè¨¼**: é•·ã•ã€æ–‡å­—ç¨®ã€å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯

### 4. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

- **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**: jsdomç’°å¢ƒã§ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆ
- **Storybookãƒ†ã‚¹ãƒˆ**: Playwrightãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§UIã‚’ãƒ†ã‚¹ãƒˆ
- **æœ€å°é™ã®E2E**: é‡è¦ãƒ•ãƒ­ãƒ¼ã®ã¿æ‰‹å‹•ãƒ†ã‚¹ãƒˆ

### 5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- **esbuildé«˜é€Ÿãƒ“ãƒ«ãƒ‰**: 1ç§’æœªæº€ã§ãƒãƒ³ãƒ‰ãƒ«å®Œäº†
- **ã‚³ãƒ¼ãƒ‰é‡è¤‡å‰Šæ¸›**: similarity-tsåˆ†æã§ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
- **é…å»¶ãƒ­ãƒ¼ãƒ‰**: å¿…è¦ãªæ©Ÿèƒ½ã®ã¿ã‚’å‹•çš„ãƒ­ãƒ¼ãƒ‰ï¼ˆä»Šå¾Œæ¤œè¨ï¼‰

---

## å‚è€ƒè³‡æ–™

- [Chrome Extension Manifest V3](https://developer.chrome.com/docs/extensions/mv3/)
- [Chrome Extension APIs](https://developer.chrome.com/docs/extensions/reference/)
- [`@praha/byethrow` Resultå‹](https://github.com/praha-inc/byethrow)
- [similarity-tsï¼ˆRustè£½ã‚³ãƒ¼ãƒ‰é‡è¤‡æ¤œå‡ºï¼‰](https://github.com/mizchi/similarity)
- [esbuild](https://esbuild.github.io/)
- [Valibot](https://valibot.dev/)

---

## æ›´æ–°å±¥æ­´

- **2026-02-12**: åˆç‰ˆä½œæˆï¼ˆIDç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ã€AIçµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
